DELIMITER //

CREATE DEFINER=`root`@`localhost` PROCEDURE `PERSON_SP_GET`(
    IN P_DS_NAME VARCHAR(30),
    IN P_DS_SURNAME VARCHAR(30),
    IN P_DS_NICKNAME VARCHAR(30),
    IN P_DS_EMAIL VARCHAR(100),
    IN P_PAGE INT,
    IN P_PAGE_SIZE INT
)
BEGIN
    DECLARE V_OFFSET INT;
    DECLARE V_TOTAL_RECORDS INT;
    DECLARE V_FILTERED_RECORDS INT;

    SET V_OFFSET = (P_PAGE - 1) * P_PAGE_SIZE;

    SELECT COUNT(*) INTO V_TOTAL_RECORDS FROM PERSON;

    SELECT COUNT(*) INTO V_FILTERED_RECORDS
    FROM PERSON
    WHERE
        (P_DS_NAME 		IS NULL OR 	DS_NAME 		LIKE CONCAT('%', P_DS_NAME, '%')) 		AND
        (P_DS_SURNAME   IS NULL OR 	DS_SURNAME  	LIKE CONCAT('%', P_DS_SURNAME, '%')) 	AND
        (P_DS_NICKNAME  IS NULL OR 	DS_NICKNAME 	LIKE CONCAT('%', P_DS_NICKNAME, '%')) 	AND
        (P_DS_EMAIL     IS NULL OR 	DS_EMAIL 		LIKE CONCAT('%', P_DS_EMAIL, '%'));

    SELECT 
        ID_PERSON,
        DS_NAME,
        DS_SURNAME,
        DS_NICKNAME,
        DS_EMAIL,
        DS_PHONE,
        DT_BIRTH,
        ID_STATUS,
        DT_REGISTRY
    FROM 
        PERSON
    WHERE
        (P_DS_NAME 		IS NULL OR 	DS_NAME 	LIKE CONCAT('%', P_DS_NAME, '%')) 		AND
        (P_DS_SURNAME 	IS NULL OR 	DS_SURNAME 	LIKE CONCAT('%', P_DS_SURNAME, '%')) 	AND
        (P_DS_NICKNAME 	IS NULL OR 	DS_NICKNAME LIKE CONCAT('%', P_DS_NICKNAME, '%')) 	AND
        (P_DS_EMAIL 	IS NULL OR 	DS_EMAIL 	LIKE CONCAT('%', P_DS_EMAIL, '%'))
    ORDER BY 
        DS_NAME ASC
    LIMIT 
        P_PAGE_SIZE
    OFFSET 
        V_OFFSET;

    SELECT V_TOTAL_RECORDS AS TOTAL_RECORDS, V_FILTERED_RECORDS AS FILTERED_RECORDS;
END //

DELIMITER ;